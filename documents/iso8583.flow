<h1 id="iso8583">ISO 8583</h1>
<h2 id="overview">Overview</h2>
<p>ISO 8583 is an international standard for financial transaction card originated interchange messaging. It is the
  International Organization for Standardization standard for systems that exchange electronic transactions initiated by
  cardholders using payment cards. ISO 8583 defines a message format and a communication flow so that different systems
  can exchange these transaction requests and responses.</p>
<h2 id="messageformat">Message Format</h2>
<p>An ISO 8583 message is made of the following parts:</p>
<ul>
  <li>Message type indicator (MTI)</li>
  <li>One or more bitmaps, indicating which data elements are present</li>
  <li>Data elements, the actual information fields of the message</li>
</ul>
<h3 id="messagetypeindicator">Message Type Indicator</h3>
<p>The Message Type Indicator is a four digit numeric field that represents the following: the ISO 8583 version, the
  message class, the message function, and the message origin.</p>
<h4 id="iso8583version">ISO 8583 Version</h4>
<p>This field defines the version of the ISO 8583 message.</p>
<table>
  <thead>
  <tr>
    <th>Code</th>
    <th>Meaning</th>
  </tr>
  </thead>
  <tbody>
  <tr>
    <td>0xxx</td>
    <td>ISO 8583:1987</td>
  </tr>
  <tr>
    <td>1xxx</td>
    <td>ISO 8583:1993</td>
  </tr>
  <tr>
    <td>2xxx</td>
    <td>ISO 8583:2003</td>
  </tr>
  <tr>
    <td>3xxx</td>
    <td>Reserved for ISO use</td>
  </tr>
  <tr>
    <td>4xxx</td>
    <td>Reserved for ISO use</td>
  </tr>
  <tr>
    <td>5xxx</td>
    <td>Reserved for ISO use</td>
  </tr>
  <tr>
    <td>6xxx</td>
    <td>Reserved for ISO use</td>
  </tr>
  <tr>
    <td>7xxx</td>
    <td>Reserved for ISO use</td>
  </tr>
  <tr>
    <td>8xxx</td>
    <td>National Use</td>
  </tr>
  <tr>
    <td>9xxx</td>
    <td>Private Use</td>
  </tr>
  </tbody>
</table>
<h4 id="messageclass">Message Class</h4>
<p>This field defines the overall purpose of the message.</p>
<table>
  <thead>
  <tr>
    <th>Code</th>
    <th>Meaning</th>
    <th>Usage</th>
  </tr>
  </thead>
  <tbody>
  <tr>
    <td>x0xx</td>
    <td>Reserved for ISO use</td>
    <td></td>
  </tr>
  <tr>
    <td>x1xx</td>
    <td>Authorization messages</td>
    <td>Determine if funds are available, get an approval but do not post to account for reconciliation. Dual message
      system (DMS), awaits file exchange for posting to the account.
    </td>
  </tr>
  <tr>
    <td>x2xx</td>
    <td>Financial messages</td>
    <td>Determine if funds are available, get an approval and post directly to the account. Single message system (SMS),
      no file exchange after this.
    </td>
  </tr>
  <tr>
    <td>x3xx</td>
    <td>File actions messages</td>
    <td>Used for hot-card, TMS and other exchanges</td>
  </tr>
  <tr>
    <td>x4xx</td>
    <td>Reversal and chargeback messages</td>
    <td>Reversal (x4x0 or x4x1): Reverses the action of a previous authorization. Chargeback (x4x2 or x4x3): Charges
      back a previously cleared financial message.
    </td>
  </tr>
  <tr>
    <td>x5xx</td>
    <td>Reconciliation messages</td>
    <td>Transmits settlement information message.</td>
  </tr>
  <tr>
    <td>x6xx</td>
    <td>Administrative messages</td>
    <td>Transmits administrative advice. Often used for failure messages (e.g. message reject or failure to apply).</td>
  </tr>
  <tr>
    <td>x7xx</td>
    <td>Fee collection messages</td>
    <td></td>
  </tr>
  <tr>
    <td>x8xx</td>
    <td>Network management messages</td>
    <td>Used for secure key exchange, logon, echo test and other network functions.</td>
  </tr>
  <tr>
    <td>x9xx</td>
    <td>Reserved for ISO use</td>
    <td></td>
  </tr>
  </tbody>
</table>
<h4 id="messagefunction">Message Function</h4>
<p>This field defines how the message should flow within the system.</p>
<table>
  <thead>
  <tr>
    <th>Code</th>
    <th>Meaning</th>
    <th>Notes</th>
  </tr>
  </thead>
  <tbody>
  <tr>
    <td>xx0x</td>
    <td>Request</td>
    <td></td>
  </tr>
  <tr>
    <td>xx1x</td>
    <td>Request response</td>
    <td></td>
  </tr>
  <tr>
    <td>xx2x</td>
    <td>Advice</td>
    <td></td>
  </tr>
  <tr>
    <td>xx3x</td>
    <td>Advice response</td>
    <td></td>
  </tr>
  <tr>
    <td>xx4x</td>
    <td>Notification</td>
    <td></td>
  </tr>
  <tr>
    <td>xx5x</td>
    <td>Notification acknowledgement</td>
    <td></td>
  </tr>
  <tr>
    <td>xx6x</td>
    <td>Instruction</td>
    <td>ISO 8583:2003 only</td>
  </tr>
  <tr>
    <td>xx7x</td>
    <td>Instruction acknowledgement</td>
    <td>ISO 8583:2003 only</td>
  </tr>
  <tr>
    <td>xx8x</td>
    <td>Reserved for ISO use</td>
    <td>Some implementations (such as MasterCard) use for positive acknowledgment.</td>
  </tr>
  <tr>
    <td>xx9x</td>
    <td>Reserved for ISO use</td>
    <td>Some implementations (such as MasterCard) use for negative acknowledgment.</td>
  </tr>
  </tbody>
</table>
<h4 id="messageorigin">Message Origin</h4>
<p>This field defines the location of the message source within the payment chain.</p>
<table>
  <thead>
  <tr>
    <th>Code</th>
    <th>Meaning</th>
  </tr>
  </thead>
  <tbody>
  <tr>
    <td>xxx0</td>
    <td>Acquirer</td>
  </tr>
  <tr>
    <td>xxx1</td>
    <td>Acquirer repeat</td>
  </tr>
  <tr>
    <td>xxx2</td>
    <td>Issuer</td>
  </tr>
  <tr>
    <td>xxx3</td>
    <td>Issuer repeat</td>
  </tr>
  <tr>
    <td>xxx4</td>
    <td>Other</td>
  </tr>
  <tr>
    <td>xxx5</td>
    <td>Other repeat</td>
  </tr>
  <tr>
    <td>xxx6</td>
    <td>Reserved for ISO use</td>
  </tr>
  <tr>
    <td>xxx7</td>
    <td>Reserved for ISO use</td>
  </tr>
  <tr>
    <td>xxx8</td>
    <td>Reserved for ISO use</td>
  </tr>
  <tr>
    <td>xxx9</td>
    <td>Reserved for ISO use</td>
  </tr>
  </tbody>
</table>
<h3 id="bitmap">Bitmap</h3>
<p>In ISO 8583, a bitmap is a field or subfield within a message, which indicates whether other data elements or data
  element subfields are present elsewhere in the message.</p>
<h3 id="dataelements">Data Elements</h3>
<p>Data elements are the individual fields carrying the transaction information. There are up to 128 data elements
  specified in the original ISO 8583:1987 standard, and up to 192 data elements in later releases. The 1993 revision
  added new definitions, deleted some, while leaving the message format itself unchanged.</p>
<p>While each data element has a specified meaning and format, the standard also includes some general purpose data
  elements and system- or country-specific data elements which vary enormously in use and form from implementation to
  implementation.</p>
<h2 id="implementation">Implementation</h2>
<h3 id="isomessage">ISOMessage</h3>
<p>The ISOMessage class is used construct an ISO 8583 message. Using this class one is able to set data elements for
  their message and then pack them into the ISO 8583 message format. To package each data element a packager class must
  be specified. ISO 8583 is a very generic message format and does not provide much information in the way of how a
  specific field must be packaged. To get around this we use a packager interface which determines how to pack specific
  fields.</p>
<h4 id="usage">Usage</h4>
<p>To set string data elements on an ISOMessage:</p>
<code>// create an ISO 8583:1987 message
foam.core.X x = foam.core.EmptyX.instance();
net.nanopay.iso8583.ISOMessage message = new net.nanopay.iso8583.ISOMessage.Builder(x)
    .setPackager(new net.nanopay.iso8583.ISO87Packager())
    .build();

// set MTI and primary account number
message.set(0, "0100");
message.set(2, "1234567890123456789");</code>
<p>To set binary data elements on an ISOMessage:</p>
<code>// create an ISO 8583:1987 message
foam.core.X x = foam.core.EmptyX.instance();
net.nanopay.iso8583.ISOMessage message = new net.nanopay.iso8583.ISOMessage.Builder(x)
    .setPackager(new net.nanopay.iso8583.ISO87Packager())
    .build();

// set message security code
message.set(96, new byte[] { 0x01, 0x02, 0x03, 0x04 });</code>
<p>To pack an ISOMessage:</p>
<code>// create an ISO 8583:1987 message
foam.core.X x = foam.core.EmptyX.instance();
net.nanopay.iso8583.ISOMessage message = new net.nanopay.iso8583.ISOMessage.Builder(x)
    .setPackager(new net.nanopay.iso8583.ISO87Packager())
    .build();

// set MTI and primary account number
message.set(0, "0100");
message.set(2, "1234567890123456789");

// pack into a ByteArrayOutputStream
java.io.ByteArrayOutputStream baos = new java.io.ByteArrayOutputStream();
message.pack(baos);

// print out bytes
System.out.println(java.util.Arrays.toString(baos.toByteArray()));</code>
<p>To unpack an ISOMessage:</p>
<code>// create an ISO 8583:1987 message
foam.core.X x = foam.core.EmptyX.instance();
net.nanopay.iso8583.ISOMessage message = new net.nanopay.iso8583.ISOMessage.Builder(x)
    .setPackager(new net.nanopay.iso8583.ISO87Packager())
    .build();

java.io.ByteArrayInputStream bais = ... // load a ISO 8583 from some source (file, network call)
message.unpack(bais);

// print out unpacked message
System.out.println(new foam.lib.json.Outputter(foam.lib.json.OutputterMode.STORAGE).stringify(message););</code>
<h3 id="packagers">Packagers</h3>
<p>Every ISOMessage class must have a packager so that it will be able to pack/unpack each data element. The following
  packages are available for use:</p>
<ul>
  <li><b>ISO87Packager</b>: a packager with data elements corresponding to the 1987 version of the ISO 8583 standard.
  </li>
  <li><b>ISO93Packager</b>: a packager with data elements corresponding to the 1993 version of the ISO 8583 standard.
  </li>
</ul>
