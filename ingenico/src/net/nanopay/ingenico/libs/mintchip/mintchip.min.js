!function(e){"use strict";function r(e,r,t){return e?r<0||t<0||r+t>e.length?null:new Uint8Array(e.slice(r,r+t)):null}function t(e,r){if(!r)return null;var t=r.length,n=(e=e||new Uint8Array(0)).length,i=new Uint8Array(n+t);return i.set(e,0),i.set(r,n),i}function n(e,r){var t,n;if(!r||e<0)return-1;if(e+2>r.length-1)return-1;var i=255&r[e+1];if(i<=127)n=e+2;else{if((t=127&i)>4||0===t)return-1;n=e+2+t}return n}function i(e){return e<=127?2:e<256?3:e<65536?4:5}function a(e,r){var t,n=-1;if(!r||e<0)return-1;if(e+1>r.length-1)return-1;var i=255&r[e+1];if(i<=127)n=i;else{if(t=127&i,e+1+1+t>r.length)return-1;switch(t){case 1:n=255&r[e+2];break;case 2:n=(255&r[e+2])<<8,n|=255&r[e+3];break;case 3:n=(255&r[e+2])<<16,n|=(255&r[e+3])<<8,n|=255&r[e+4];break;case 4:n=(255&r[e+2])<<24,n|=(255&r[e+3])<<16,n|=(255&r[e+4])<<8,n|=255&r[e+5];break;default:return-1}}return n<0?n>>>0:n}function o(e){if(!e)return null;if(3===e.length){var r=e[0],t=e[1],n=e[2],i=2010+((240&r)>>4),a=(15&r)-1,o=(248&t)>>3,s=(t<<5&224)>>3|(255&n)>>6,h=63&n;return new Date(Date.UTC(i,a,o,s,h,0,0))}if(4===e.length){var l=946684800+e.readUIntBE(0,4);return new Date(1e3*l)}return null}function s(e){return e?String.fromCharCode.apply(null,e):null}function h(e){if(!e)return null;for(var r=new Uint8Array(e.length),t=0;t<e.length;t++)r[t]=e.charCodeAt(t);return r}function l(e){if(!e)return null;for(var r="",t=0;t<e.length;t++)r+=String.fromCharCode(e[t]);return btoa(r)}function d(e){if(!e)return null;for(var r=atob(e),t=r.length,n=new Uint8Array(new ArrayBuffer(t)),i=0;i<t;i++)n[i]=r.charCodeAt(i);return n}function u(e){if(!e)return null;for(var r="",t=0;t<e.length;t++){var n=(255&e[t]).toString(16);r+=n=1===n.length?"0"+n:n}return r.toUpperCase()}function f(e){if(!e)return null;e.length%2!=0&&(e="0"+e);for(var r=[],t=0;t<e.length;t+=2)r.push(parseInt(e.substr(t,2),16));return new Uint8Array(r)}function c(e){if(!e)return null;if(8!==e.length)return null;for(var r="",t=0;t<8;t++){var n=(240&e[t])>>4,i=15&e[t];r+=n.toString()+i.toString()}return this.MintChipIdToBytes(r)?r:null}function v(e){if(!e)return null;var r=Number(e);if(isNaN(r))return null;if(16!==r.toString().length)return null;e=e.toString();for(var t=0,n=new Uint8Array(8),i=1;i<=16;i++){var a=1+i%2,o=parseInt(e.substring(i-1,i),10),s=o*a;s>9&&(s-=9),t+=s,i%2==1?n[(i-1)/2]=o<<4:n[parseInt((i-1)/2,10)]|=o}return t%10!=0?null:n}function w(e,r){if(!e)return null;if(r){if(r>e.length)return null;for(var t="",n=0;n<r;n++)t+=e[n].toString(16);return parseInt(t,16)}return parseInt(u(e),16)}function g(e,r){if(!e)return null;var t=(e=e<0?e>>>0:e).toString(16);if(r){for(r*=2;t.length<r;)t="0"+t;return f(t)}return t.length%2!=0&&(t="0"+t),f(t)}function p(e){return!e||e.length<1?null:((240&e[0])>>4)+"."+(15&e[0])}function y(e){return!e||e.length<1?null:255===e[0]}function m(e){return e?new Uint8Array([255]):new Uint8Array([0])}function I(e){if(!e)throw new Error("Invalid ASN Node");if(e.tag&&e.data&&e.offset>=0&&e.length>0)this.tag=e.tag,this.length=e.length,this.value=r(e.data,e.offset,e.length);else if(e.rawTlv){this.tag=e.rawTlv[0],this.length=a(0,e.rawTlv);var t=n(0,e.rawTlv);this.value=r(e.rawTlv,t,this.length)}else if(e.tag&&e.data)this.tag=e.tag,this.length=e.data.length,this.value=r(e.data,0,this.length);else{if(!e.tag)throw new Error("Invalid ASN Node");this.tag=e.tag,this.length=0}this.children=[]}function E(e){this.parseValueRequestMessage(e)}function D(e){this.parseValueMessage(e)}I.prototype.addChild=function(e){this.children.push(e)},I.prototype.getDerEncoding=function(){for(var e,r=0,n=null,i=0;i<this.children.length;i++)n=t(n,this.children[i].getDerEncoding());return null!==n&&(r=n.length),r+=this.length,r<=127?((e=new Uint8Array(2))[0]=this.tag,e[1]=r):r<256?((e=new Uint8Array(3))[0]=this.tag,e[1]=129,e[2]=r):r<65536?((e=new Uint8Array(4))[0]=this.tag,e[1]=130,e[2]=(65280&r)>>8,e[3]=255&r):r<16777216?((e=new Uint8Array(5))[0]=this.tag,e[1]=131,e[2]=(16711680&r)>>16,e[3]=(65280&r)>>8,e[4]=255&r):((e=new Uint8Array(6))[0]=this.tag,e[1]=132,e[2]=(4278190080&r)>>24,e[3]=(16711680&r)>>16,e[4]=(65280&r)>>8,e[5]=255&r),this.value&&(e=t(e,this.value)),n&&(e=t(e,n)),e},Object.defineProperty(E.prototype,"annotation",{get:function(){return s(this._annotation)},set:function(e){this._annotation=e}}),Object.defineProperty(E.prototype,"payeeId",{get:function(){return c(this._payeeId)},set:function(e){this._payeeId=e}}),Object.defineProperty(E.prototype,"currencyCode",{get:function(){return w(this._currencyCode)},set:function(e){this._currencyCode=e}}),Object.defineProperty(E.prototype,"amount",{get:function(){return w(this._amount)},set:function(e){this._amount=e}}),Object.defineProperty(E.prototype,"certificateRequested",{get:function(){return y(this._certificateRequested)},set:function(e){this._certificateRequested=e}}),Object.defineProperty(E.prototype,"responseAddress",{get:function(){return s(this._responseAddress)},set:function(e){this._responseAddress=e}}),Object.defineProperty(E.prototype,"challenge",{get:function(){return u(this._challenge)},set:function(e){this._challenge=e}}),Object.defineProperty(E.prototype,"vrmDer",{get:function(){return this._vrmDer},set:function(e){this._vrmDer=e}}),E.prototype.parseValueRequestMessage=function(e){var t,o=0;if(!e||0===e.length||e.length>3096)throw new Error("Invalid vrmb64");var s=d(e);if(96!==s[o])throw new Error("Invalid application tag");if(-1===(o=n(o,s)))throw new Error("Invalid sequence tag");if(48!==s[o])throw new Error("Invalid sequence tag");if(-1===(o=n(o,s)))throw new Error("Invalid message version");if(160!==s[o])throw new Error("Invalid message version");if(o+=5,161===s[o]){var h;if(-1===(o=n(o,s)))throw new Error("Invalid message annotation");if(22!==s[o])throw new Error("Invalid message annotation");if(-1===(t=a(o,s)))throw new Error("Invalid message annotation");if(-1===(h=n(o,s)))throw new Error("Invalid message annotation");this.annotation=r(s,h,t),o+=h-o+t}if(-1===(o=n(o,s)))throw new Error("Invalid message choice");if(161!==s[o])throw new Error("Invalid message choice");if(-1===(o=n(o,s)))throw new Error("Invalid inner sequence tag");if(48!==s[o])throw new Error("Invalid inner sequence tag");var l=(t=a(o,s))+i(t);if(this.vrmDer=r(s,o,l),o=0,-1===(o=n(o,this.vrmDer)))throw new Error("Invalid payee id");if(-1===(t=a(o,this.vrmDer)))throw new Error("Invalid payee id");if(o+=2,this.payeeId=this.vrmDer.slice(o,o+t),o+=t,-1===(t=a(o,this.vrmDer)))throw new Error("Invalid currency code");if(-1===(o=n(o,this.vrmDer)))throw new Error("Invalid currency code");if(this.currencyCode=this.vrmDer.slice(o,o+t),o+=t,-1===(t=a(o,this.vrmDer)))throw new Error("Invalid amount");if(-1===(o=n(o,this.vrmDer)))throw new Error("Invalid amount");if(this.amount=this.vrmDer.slice(o,o+t),o+=t,-1===(t=a(o,this.vrmDer)))throw new Error("Invalid certificate requested");if(-1===(o=n(o,this.vrmDer)))throw new Error("Invalid certificate requested");if(this.certificateRequested=this.vrmDer.slice(o,o+t),o+=t,-1===(t=a(o,this.vrmDer)))throw new Error("Invalid response address");if(-1===(o=n(o,this.vrmDer)))throw new Error("Invalid response address");if(this.responseAddress=this.vrmDer.slice(o,o+t),o+=t,128===this.vrmDer[o]){if(-1===(t=a(o,this.vrmDer)))throw new Error("Invalid challenge");if(-1===(o=n(o,this.vrmDer)))throw new Error("Invalid challenge");this.challenge=this.vrmDer.slice(o,o+t)}},E.buildValueRequestMessagePacket=function(e,r,t,n,i){if(!v(e))throw new Error("Invalid Payee ID");if(r<1||r>65535)throw new Error("Invalid Currency Code");if(t<1||t>0xffffffffff)throw new Error("Invalid Amount");if(n&&4!==(n=f(n)).length)throw new Error("Invalid Challenge");var a=new I({tag:10,data:new Uint8Array([1])}),o=new I({tag:160});o.addChild(a);var s=null;if(i){var d=new I({tag:22,data:h(i)});(s=new I({tag:161})).addChild(d)}var u=new I({tag:48});u.addChild(new I({tag:4,data:v(e)})),u.addChild(new I({tag:4,data:g(r,1)})),u.addChild(new I({tag:4,data:g(t,3)})),u.addChild(new I({tag:1,data:m(!0)})),u.addChild(new I({tag:22,data:h("")})),n&&u.addChild(new I({tag:128,data:n}));var c=new I({tag:161});c.addChild(u);var w=new I({tag:162});w.addChild(c);var p=new I({tag:48});p.addChild(o),s&&p.addChild(s),p.addChild(w);var y=new I({tag:96});return y.addChild(p),l(y.getDerEncoding())},Object.defineProperty(D.prototype,"annotation",{get:function(){return s(this._annotation)},set:function(e){this._annotation=e}}),Object.defineProperty(D.prototype,"version",{get:function(){return p(this._version)},set:function(e){this._version=e}}),Object.defineProperty(D.prototype,"payeeId",{get:function(){return c(this._payeeId)},set:function(e){this._payeeId=e}}),Object.defineProperty(D.prototype,"payerId",{get:function(){return c(this._payerId)},set:function(e){this._payerId=e}}),Object.defineProperty(D.prototype,"currencyCode",{get:function(){return w(this._currencyCode)},set:function(e){this._currencyCode=e}}),Object.defineProperty(D.prototype,"amount",{get:function(){return w(this._amount)},set:function(e){this._amount=e}}),Object.defineProperty(D.prototype,"challenge",{get:function(){return u(this._challenge)},set:function(e){this._challenge=e}}),Object.defineProperty(D.prototype,"createdTime",{get:function(){return o(this._createdTime)},set:function(e){this._createdTime=e}}),Object.defineProperty(D.prototype,"encryptedTac",{get:function(){return this._encryptedTac},set:function(e){this._encryptedTac=e}}),Object.defineProperty(D.prototype,"signature",{get:function(){return this._signature},set:function(e){this._signature=e}}),Object.defineProperty(D.prototype,"payerCertificate",{get:function(){return this._payerCertificate},set:function(e){this._payerCertificate=e}}),Object.defineProperty(D.prototype,"vmDer",{get:function(){return this._vmDer},set:function(e){this._vmDer=e}}),D.prototype.parseValueMessage=function(e){var t,o=0;if(!e||0===e.length||e.length>3096)throw new Error("Invalid vtmb64");var s=d(e);if(96!==s[o])throw new Error("Invalid application");if(-1===(o=n(o,s)))throw new Error("Invalid sequence tag");if(48!==s[o])throw new Error("Invalid sequence tag");if(-1===(o=n(o,s)))throw new Error("Invalid message version");if(160!==s[o])throw new Error("Invalid message version");if(o+=5,161===s[o]){var h;if(-1===(o=n(o,s)))throw new Error("Invalid message annotation");if(22!==s[o])throw new Error("Invalid message annotation");if(-1===(t=a(o,s)))throw new Error("Invalid message annotation");if(-1===(h=n(o,s)))throw new Error("Invalid message annotation");this.annotation=r(s,h,t),o+=h-o+t}if(-1===(o=n(o,s)))throw new Error("Invalid message choice");if(171!==s[o])throw new Error("Invalid message choice");if(-1===(o=n(o,s)))throw new Error("Invalid inner sequence tag");if(48!==s[o])throw new Error("Invalid inner sequence tag");if(-1===(o=n(o,s)))throw new Error("Invalid inner sequence tag");if(48!==s[o])throw new Error("Invalid inner sequence tag");var l=(t=a(o,s))+i(t);if(this.vmDer=r(s,o,l),(o+=l)<s.length){if(160!==s[o])throw new Error("Invalid certificate");this.payerCertificate=r(s,o,s.length-o),this.payerCertificate[0]=48}if(o=0,48!==this.vmDer[o])throw new Error("Invalid inner sequence tag");if(-1===(o=n(o,this.vmDer)))throw new Error("Invalid version");if(-1===(t=a(o,this.vmDer)))throw new Error("Invalid version");if(o+=2,this.version=this.vmDer.slice(o,o+t),o+=t,-1===(t=a(o,this.vmDer)))throw new Error("Invalid payer id");if(-1===(o=n(o,this.vmDer)))throw new Error("Invalid payer id");if(this.payerId=this.vmDer.slice(o,o+t),o+=t,-1===(t=a(o,this.vmDer)))throw new Error("Invalid payee id");if(-1===(o=n(o,this.vmDer)))throw new Error("Invalid payee id");if(this.payeeId=this.vmDer.slice(o,o+t),o+=t,-1===(t=a(o,this.vmDer)))throw new Error("Invalid currency code");if(-1===(o=n(o,this.vmDer)))throw new Error("Invalid currency code");if(this.currencyCode=this.vmDer.slice(o,o+t),o+=t,-1===(t=a(o,this.vmDer)))throw new Error("Invalid amount");if(-1===(o=n(o,this.vmDer)))throw new Error("Invalid amount");if(this.amount=this.vmDer.slice(o,o+t),o+=t,-1===(t=a(o,this.vmDer)))throw new Error("Invalid challenge");if(-1===(o=n(o,this.vmDer)))throw new Error("Invalid challenge");if(this.challenge=this.vmDer.slice(o,o+t),o+=t,-1===(t=a(o,this.vmDer)))throw new Error("Invalid date time");if(-1===(o=n(o,this.vmDer)))throw new Error("Invalid date time");if(this.createdTime=this.vmDer.slice(o,o+t),o+=t,-1===(t=a(o,this.vmDer)))throw new Error("Invalid TAC");if(-1===(o=n(o,this.vmDer)))throw new Error("Invalid TAC");if(this.encryptedTac=this.vmDer.slice(o,o+t),o+=t,-1===(t=a(o,this.vmDer)))throw new Error("Invalid signature");if(-1===(o=n(o,this.vmDer)))throw new Error("Invalid signature");this.signature=this.vmDer.slice(o,o+t)},D.buildValueMessagePacket=function(e,r,t){var i=new I({tag:10,data:new Uint8Array([1])}),o=new I({tag:160});o.addChild(i);var s=null;if(t){var d=new I({tag:22,data:h(t)});(s=new I({tag:161})).addChild(d)}var u=new I({tag:48});if(u.addChild(new I({rawTlv:e})),r){var f=a(0,r),c=new I({tag:160,data:r,offset:n(0,r),length:f});u.addChild(c)}var v=new I({tag:171});v.addChild(u);var w=new I({tag:162});w.addChild(v);var g=new I({tag:48});g.addChild(o),s&&g.addChild(s),g.addChild(w);var p=new I({tag:96});return p.addChild(g),l(p.getDerEncoding())},"undefined"!=typeof module?module.exports={ValueRequestMessage:E,ValueTransferMessage:D}:(window.ValueRequestMessage=E,window.ValueTransferMessage=D)}();